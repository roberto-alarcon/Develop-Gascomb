<?php	header('Content-Type: text/html; charset=utf-8');	include_once('/home/gascomb/secure_html/config/set_variables.php');		include_once(PATH_CLASSES_FOLDER.'class.activities.php');	include_once(PATH_CLASSES_FOLDER.'class.employees.php');		$id = $_GET['folio'];	//$id = 204;	$activity = new FloorActivity;	$employee = new Employee;	$activities = $activity->getActivitiesArray($id);	$support_activities = $activity->getSupportActivities();	//print_r($activities);	$mecanics = $employee->getMechanics();	array_sort_by_column($mecanics, 'name');	//Funcion para ordenar array por un valor	function array_sort_by_column(&$arr, $col, $dir = SORT_ASC) {		$sort_col = array();		foreach ($arr as $key=> $row) {			$sort_col[$key] = $row[$col];		}		array_multisort($sort_col, $dir, $arr);	}?><!DOCTYPE html><html>	<head>		<meta  name = "viewport" content = "initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no">		<!--  JQuery Mobile library -->		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />		<link type="text/css" href="js/datebox/jqm-datebox.min.css" rel="stylesheet" /> 				<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>		<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>		<script type="text/javascript" src="js/datebox/jqm-datebox.core.min.js"></script>		<script type="text/javascript" src="js/datebox/jqm-datebox.mode.calbox.min.js"></script>		<script type="text/javascript" src="js/datebox/jqm-datebox.mode.datebox.min.js"></script>						<script>			var productsarray = new Array()			var folio_id = <?php echo $id;?>;			$(document).ready(function(){				$.mobile.defaultPageTransition = 'none';				var count=1;				$( "body" ).delegate( "#btnEliminar", "click", function() {					var floor_activity_id = $(this).val();					$.ajax({							url: "./ajax/add_update_task.php?action=delete&floor_activity_id="+floor_activity_id,							type: "POST"												})						.done( function ( response ) {							//console.log(response);							if(response == "true"){																						alert("Se ha eliminado la tarea seleccionada");								window.location = "update_task_form.php?folio=<?php echo $id; ?>&tab=2&subtab=2";																//refreshPage(); 							}else{								alert("Ocurrió un problema al eliminar la tarea");							}													});					console.log($(this).val());				});				//Aplicar el mismo empleado que el primer item				$( "#employee_id" ).first().on( "change", function(event, ui) {					var first_employee = $(this).val();					$('.activity:visible').each(function() {						$(this).find('#employee_id').val(first_employee);						$(this).find('#employee_id').selectmenu('refresh');					});									});								$( ".fecha" ).first().on( "change", function(event, ui) {					var date_first = $(this).val();					$('.activity:visible').each(function() {						$(this).find('.fecha').val(date_first);											});									});												$( '#btnGuardar').on( "click", function(event, ui) {																								var activities = [];					$('.activity:visible').each(function() {						if($(this).find('.fecha').val() !== '' && $(this).find(".hora").val() !== ''){								var datetime = $(this).find('.fecha').val()+" "+$(this).find(".hora").val();								var timeunix = new Date(datetime).getTime() / 1000;						}else{														var timeunix = 0;						}												var activity = {};																		activity.floor_activity_id = $(this).find('.floor_activity_id').val();						activity.employee_id = $(this).find('.employee_id option:selected').val();						activity.time_start = timeunix;						activity.support_activity_id = $(this).find('#support_activities_id option:selected').val();						activity.description = $(this).find('#support_activities_id option:selected').text();						activity.max_time_hours = $(this).find('.max_time_hours').val();						activity.status = $(this).find('#status option:selected').val();						activity.comments = $(this).find('.comments').val();						activities.push(activity);					});											if(activities.length !== 0){						var act = JSON.stringify(activities)						//alert(act); return false;												$.ajax({							url: "./ajax/add_update_task.php?action=update&folio="+folio_id+"&activities="+act,							type: "POST"												})						.done( function ( response ) {														if(response == "true"){																						alert("Se ha guardado la información");								window.location = "admin_task.php?folio=<?php echo $id; ?>&tab=2&subtab=1";								//refreshPage(); 							}else{								alert("Ocurrió un problema al solicitar productos");							}													});											}				});								/*function refreshPage() {					  $.mobile.changePage(						window.location.href,						{						  allowSamePageTransition : true,						  transition              : 'none',						  showLoadMsg             : false,						  reloadPage              : true						}					  );					}*/										});					</script>					</head>	<body>	<div data-role="page" id="home">		<div data-role="header">			<h1> Módulo :: Administración de tareas :: Folio - <?php echo $id; ?></h1>						 <?php include_once 'menu.php';?>				 <div data-role="navbar">				<ul>					<li><a href="admin_task.php?folio=<?php echo $id;?>&tab=2&subtab=1" data-ajax="false">Gráfica de Gantt</a></li>					<li><a href="update_task_form.php?folio=<?php echo $id;?>&tab=2&subtab=2" class="ui-btn-active ui-state-persist" data-ajax="false">Asignar / Modificar tareas</a></li>					<li><a href="admin_task_form.php?folio=<?php echo $id;?>&tab=2&subtab=3" data-ajax="false">Agregar nueva tarea</a></li>														</ul>			</div>						</div>		<div data-role="content">									<?php 			//print_r($activities);			if (empty($activities)) {				echo '<p style="color:#666;margin:20px;font-family:Arial;font-size: .9em;font-weight: bold;">No se han agregado tareas</p>';			}else{							foreach($activities as $activ){ ?>									<ul class="activity" id="activity0" data-role='listview' data-inset='true' style="width:95%; margin:10px auto;">							<li data-role="list-divider">								<div class="ui-grid-b my-breakpoint">									<div class="ui-block-a" style="width:70%">										<input type="hidden" name="floor_activity_id" class="floor_activity_id" id="floor_activity_id" value="<?php echo $activ["floor_activity_id"]; ?>" />										<label for="support_activities_id" class="select">Actividad:</label>										<select name="support_activities_id" id="support_activities_id" data-mini="true" data-theme="c" style="float:right;">										<?php 										$activity_id = $activ["support_activity_id"];										foreach($support_activities as $activity){ 										if($activity["support_activities_id"] == $activity_id){											echo '<option value='.$activity["support_activities_id"].' selected>'.utf8_encode($activity["activity_name"]).'</option>'; 										}else{											echo '<option value='.$activity["support_activities_id"].'>'.utf8_encode($activity["activity_name"]).'</option>';  										}										} ?>										</select>																		</div>									<div class="ui-block-b" style="width:30%"><br>										<button type="button" id="btnEliminar" value="<?php echo $activ["floor_activity_id"]?>" data-theme="e"  data-mini="true" data-icon="delete">Eliminar</button>									</div>																	</div>							</li>							<li data-role="fieldcontain">																		<label for="fecha">Fecha de inicio:</label>								<input name="fecha" class="fecha" id="fecha" type="text" value="<?php 									if(!$activ["time_start"]){										$fehca = "";										$hora = "";									}else{										$fehca = date('Y/m/d',$activ["time_start"]);										$hora = date('H:m',$activ["time_start"]);									}																	echo $fehca;								//echo date('Y/m/d',$activ["time_start"]); ?>" data-role="datebox" data-theme="d" data-options='{"mode":"calbox", "overrideDateFormat": "%Y/%m/%d"}' />							</li>								<li data-role="fieldcontain">								<label for="hora">Hora:</label>								<input name="hora" id="hora" class="hora" type="text" value="<?php echo $hora; ?>" data-role="datebox" data-theme="d" data-options='{"mode":"timebox"}' />												</li>								<li data-role="fieldcontain">								<label for="employee_id" class="select">Mecanico asignado:</label>								<select name="employee_id"  class="employee_id" id="employee_id" data-mini="true">								<?php 								$mechanic_id = $activ["employee_id"]; 								foreach($mecanics as $mecanic){ 									if($mecanic["employee_id"] == $mechanic_id){										echo '<option value='.$mecanic["employee_id"].' selected>'.utf8_encode($mecanic["name"]." ".$mecanic["last_name"]).'</option>'; 									}else{										echo '<option value='.$mecanic["employee_id"].'>'.utf8_encode($mecanic["name"]." ".$mecanic["last_name"]).'</option>'; 									}																																	} ?>								</select>							</li>							<li data-role="fieldcontain">									<label for="max_time_hours">Tiempo de entrega(Hrs):</label>									<input type="number" name="max_time_hours" class="max_time_hours" id="max_time_hours" min="1" max="50" value="<?php echo ($activ["max_time_hours"])?$activ["max_time_hours"]:1; ?>" />							</li>							<li data-role="fieldcontain">								<label for="status" class="select">Status:</label>																<select name="status" class="status" id="status" data-mini="true">									<?php $status = $activ["status"]; 									$search_array = array('1' => 'En proceso', '2' => 'Detenido','3' => 'Finalizado');									foreach($search_array as $key=>$value){												if($status == $key){												echo '<option value="'.$key.'" selected>'.$value.'</option>';											}else{											echo '<option value="'.$key.'">'.$value.'</option>';											}															}																								?>								</select>							</li>							<li data-role="fieldcontain" data-mini="true">								<label for="comments">Comentarios:</label>								<textarea cols="40" rows="8" name="comments" class="comments" id="comments" value="<?php echo $activ["comments"]; ?>" data-mini="true"></textarea>							</li>					</ul>				<?php } ?>										<fieldset class="ui-grid-solo" style="width:95%; margin:10px auto 0px;">													<div class="ui-block-a"><button type="button" id="btnGuardar" data-theme="e" data-icon="check">Guardar</button></div>					</fieldset>				<?php } ?>					</div>		<?php  include "footer.php";?>	</div>		</body></html>